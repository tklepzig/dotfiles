#!/usr/bin/env ruby
# frozen_string_literal: true

require 'English'
require 'json'

secondary_bg = ENV['secondaryBg']
secondary_fg = ENV['secondaryFg']
cache_time = 60

output = `gh api -i --cache #{cache_time}s notifications`
exit 1 unless $CHILD_STATUS.success?

# rate_limit_remaining = output.lines.find { |line| line.start_with?('X-Ratelimit-Remaining:') }.split(':').last.strip.to_i
# pp rate_limit_remaining

# Export in some way to use that for the next run as cache_time
# poll_interval = output.lines.find { |line| line.start_with?('X-Poll-Interval:') }.split(':').last.strip.to_i

json = output.split("\r\n").last
notifications = JSON.parse(json)

mentions = notifications.select { |item| item['reason'] == 'mention' }.length
prs = notifications.select { |item| item['subject']['type'] == 'PullRequest' }.length

if ARGV[0] == 'tile'
  puts "#[fg=#{secondary_fg},bg=#{secondary_bg}] #{prs.zero? ? '-' : prs}/#{mentions.zero? ? '-' : mentions} #[default] "
  exit 0
end

# TODO: Add more colors
# TODO: sort and/or group them?
# TODO: Close only on 'q' and allow navigation with j/k and opening the links
notifications.each do |item|
  puts "- [\e[0;34m#{item['repository']['full_name']}\e[0m] #{item['subject']['type']}, #{item['reason']}: #{item['subject']['title']}"
end
