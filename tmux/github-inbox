#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'

primary_bg = ENV['primaryBg']
primary_fg = ENV['primaryFg']
cache_time = 60

output = `gh api -i --cache #{cache_time}s notifications`

# rate_limit_remaining = output.lines.find { |line| line.start_with?('X-Ratelimit-Remaining:') }.split(':').last.strip.to_i
# pp rate_limit_remaining

# Export in some way to use that for the next run as cache_time
# poll_interval = output.lines.find { |line| line.start_with?('X-Poll-Interval:') }.split(':').last.strip.to_i

json = output.split("\r\n").last
notifications = JSON.parse(json)

mentions = notifications.select { |item| item['reason'] == 'mention' }.length
prs = notifications.select { |item| item['subject']['type'] == 'PullRequest' }.length

if ARGV[1] == 'tile'
  puts "#[fg=#{primary_fg},bg=#{primary_bg}] #{prs} | #{mentions}"
  exit 0
end

# TODO: sort and/or group them?
notifications.each do |item|
  puts "- [#{item['repository']['full_name']}] #{item['subject']['type']}, #{item['reason']}: #{item['subject']['title']}"
end
